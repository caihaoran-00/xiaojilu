<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="å°è®°å½•">
  <meta name="theme-color" content="#FFB6C1">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon.svg">
  <title>å°è®°å½•</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #FFF5F5; color: #333; min-height: 100vh; -webkit-tap-highlight-color: transparent; }
    .page { display: none; padding: 16px; padding-bottom: 80px; max-width: 500px; margin: 0 auto; }
    .page.active { display: block; }
    .header { text-align: center; padding: 16px 0 12px; font-size: 20px; font-weight: 700; color: #E91E63; position: relative; }
    .header small { display: block; font-size: 12px; color: #999; font-weight: 400; margin-top: 2px; }
    .user-badge { position: absolute; right: 0; top: 18px; padding: 3px 10px; border-radius: 12px; font-size: 12px; background: #FFF0F5; color: #E91E63; font-weight: 500; cursor: pointer; }
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 24px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: #E91E63; color: white; }
    .btn-primary:active { background: #C2185B; }
    .btn-success { background: #4CAF50; color: white; }
    .btn-success:active { background: #388E3C; }
    .btn-danger { background: #f44336; color: white; }
    .btn-danger:active { background: #D32F2F; }
    .btn-outline { background: white; color: #E91E63; border: 2px solid #E91E63; }
    .btn-block { display: flex; width: 100%; }
    .btn-lg { padding: 16px 32px; font-size: 18px; border-radius: 16px; }
    .btn-sm { padding: 6px 14px; font-size: 13px; border-radius: 8px; }
    .card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .input { width: 100%; padding: 14px 16px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; outline: none; transition: border-color 0.2s; }
    .input:focus { border-color: #E91E63; }
    .tag { display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; margin: 4px; cursor: pointer; transition: all 0.2s; border: 2px solid #eee; background: white; color: #666; }
    .tag.selected { border-color: #E91E63; background: #FFF0F5; color: #E91E63; }
    .tag:active { transform: scale(0.95); }
    .time-ago { color: #E91E63; font-weight: 600; }
    .record-time { color: #999; font-size: 13px; }
    .record-by { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 12px; background: #FFF0F5; color: #E91E63; }
    .record-item { padding: 12px 0; border-bottom: 1px solid #f5f5f5; }
    .record-item:last-child { border-bottom: none; }
    .record-main { display: flex; justify-content: space-between; align-items: center; }
    .record-images { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; align-items: center; }
    .record-images img { width: 56px; height: 56px; border-radius: 8px; object-fit: cover; cursor: pointer; border: 1px solid #eee; }
    .img-upload-btn { width: 56px; height: 56px; border-radius: 8px; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; color: #ccc; background: #fafafa; flex-shrink: 0; }
    .img-upload-btn:active { background: #f0f0f0; }
    .img-thumb-wrap { position: relative; display: inline-block; }
    .img-thumb-del { position: absolute; top: -4px; right: -4px; width: 18px; height: 18px; border-radius: 50%; background: #f44336; color: white; font-size: 11px; display: flex; align-items: center; justify-content: center; cursor: pointer; line-height: 1; border: 1px solid white; }
    .active-event { background: linear-gradient(135deg, #FFF0F5, #FFE0EC); border: 2px solid #E91E63; animation: pulse-border 2s infinite; }
    @keyframes pulse-border { 0%, 100% { border-color: #E91E63; } 50% { border-color: #F48FB1; } }
    .timer { font-size: 28px; font-weight: 700; color: #E91E63; font-variant-numeric: tabular-nums; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 8px 0 env(safe-area-inset-bottom, 8px); box-shadow: 0 -2px 10px rgba(0,0,0,0.08); z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; padding: 4px 12px; cursor: pointer; color: #999; font-size: 11px; transition: color 0.2s; }
    .nav-item.active { color: #E91E63; }
    .nav-item .nav-icon { font-size: 24px; margin-bottom: 2px; }
    .active-banner { display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #E91E63, #FF5722); color: white; padding: 10px 16px; z-index: 200; font-size: 14px; text-align: center; cursor: pointer; }
    .active-banner.show { display: block; }
    .active-banner .banner-timer { font-weight: 700; font-size: 16px; }
    body.has-banner .page { padding-top: 56px; }
    #loginPage { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 32px; }
    .login-title { font-size: 48px; margin-bottom: 8px; }
    .login-subtitle { font-size: 20px; color: #E91E63; font-weight: 600; margin-bottom: 32px; }
    .identity-grid { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
    .identity-btn { display: flex; flex-direction: column; align-items: center; padding: 16px 24px; border: 2px solid #eee; border-radius: 16px; background: white; cursor: pointer; transition: all 0.2s; min-width: 90px; }
    .identity-btn:active { transform: scale(0.95); }
    .identity-btn.selected { border-color: #E91E63; background: #FFF0F5; }
    .identity-btn .identity-icon { font-size: 32px; margin-bottom: 4px; }
    .identity-btn .identity-name { font-size: 14px; font-weight: 600; color: #333; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 300; justify-content: center; align-items: flex-end; }
    .modal-overlay.show { display: flex; }
    .modal { background: white; border-radius: 20px 20px 0 0; padding: 24px; width: 100%; max-width: 500px; max-height: 70vh; overflow-y: auto; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; text-align: center; }
    .delete-btn { color: #ccc; font-size: 18px; cursor: pointer; padding: 4px 8px; }
    .delete-btn:active { color: #f44336; }
    .empty-state { text-align: center; padding: 40px 20px; color: #ccc; }
    .empty-state .empty-icon { font-size: 48px; margin-bottom: 8px; }
    .empty-state .empty-text { font-size: 14px; }
    .date-group-title { font-size: 14px; font-weight: 600; color: #999; margin-bottom: 8px; padding-left: 2px; }
    .settings-popup { display: none; position: absolute; right: 0; top: 44px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 8px 0; z-index: 50; min-width: 120px; }
    .settings-popup.show { display: block; }
    .settings-popup-item { padding: 10px 20px; font-size: 14px; cursor: pointer; color: #333; }
    .settings-popup-item:active { background: #f5f5f5; }
    .img-preview-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 500; justify-content: center; align-items: center; flex-direction: column; }
    .img-preview-overlay.show { display: flex; }
    .img-preview-overlay img { max-width: 95%; max-height: 80vh; border-radius: 8px; }
    .img-preview-close { position: absolute; top: 16px; right: 16px; color: white; font-size: 32px; cursor: pointer; padding: 8px; z-index: 501; }
    .img-preview-delete { margin-top: 16px; padding: 10px 30px; background: #f44336; color: white; border: none; border-radius: 12px; font-size: 15px; cursor: pointer; }

  </style>
</head>
<body>

<!-- è¿›è¡Œä¸­äº‹ä»¶æ¨ªå¹… -->
<div class="active-banner" id="activeBanner" onclick="switchTab('duration')">
  <span id="bannerText"></span>
</div>

<!-- å›¾ç‰‡é¢„è§ˆæµ®å±‚ -->
<div class="img-preview-overlay" id="imgPreview">
  <span class="img-preview-close" onclick="closeImgPreview()">&times;</span>
  <img src="" id="imgPreviewSrc">
  <button class="img-preview-delete" id="imgPreviewDelBtn" onclick="deletePreviewImage()">åˆ é™¤å›¾ç‰‡</button>
</div>

<!-- éšè—æ–‡ä»¶è¾“å…¥ -->
<input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleImageSelected(this)">

<!-- ç™»å½•é¡µ -->
<div id="loginPage" style="display: flex;">
  <div class="login-title">&#x1F476;</div>
  <div class="login-subtitle">å°è®°å½•</div>
  <input class="input" id="passwordInput" type="password" placeholder="è¾“å…¥å¯†ç "
         style="max-width: 280px; text-align: center;">
  <div id="loginStep2" style="display: none; text-align: center; margin-top: 20px;">
    <div style="font-size: 15px; color: #666; margin-bottom: 12px;">ä½ æ˜¯è°ï¼Ÿ</div>
    <div class="identity-grid">
      <div class="identity-btn" onclick="selectIdentity('çˆ¸çˆ¸', this)">
        <span class="identity-icon">&#x1F468;</span>
        <span class="identity-name">çˆ¸çˆ¸</span>
      </div>
      <div class="identity-btn" onclick="selectIdentity('å¦ˆå¦ˆ', this)">
        <span class="identity-icon">&#x1F469;</span>
        <span class="identity-name">å¦ˆå¦ˆ</span>
      </div>
      <div class="identity-btn" onclick="selectIdentity('å¥¶å¥¶', this)">
        <span class="identity-icon">&#x1F475;</span>
        <span class="identity-name">å¥¶å¥¶</span>
      </div>
    </div>
  </div>
  <div id="loginError" style="color: #f44336; font-size: 13px; margin-top: 12px;"></div>
</div>

<!-- ä¸»åº”ç”¨ -->
<div id="mainApp" style="display: none;">

  <!-- æ—¶é—´ç‚¹è®°å½•é¡µ -->
  <div class="page active" id="instantPage">
    <div class="header" id="instantHeader">
      &#x1F476; <span id="instantTitle">å°è®°å½•</span>
      <small>è®°å½•ä¸€æ¬¡æ€§äº‹ä»¶</small>
      <span class="user-badge" id="instantBadge" onclick="toggleSettings('instantSettings')"></span>
      <div class="settings-popup" id="instantSettings">
        <div class="settings-popup-item" onclick="logout()">é€€å‡ºç™»å½•</div>
      </div>
    </div>
    <div class="card" style="text-align: center;">
      <div style="font-size: 14px; color: #999; margin-bottom: 12px;">å¿«é€Ÿè®°å½•</div>
      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-primary btn-lg" onclick="quickInstant('diaper', 'æ¢å°¿è£¤')">&#x1F9F7; æ¢å°¿è£¤</button>
        <button class="btn btn-success btn-lg" onclick="quickInstant('feed', 'å–‚å¥¶')">&#x1F37C; å–‚å¥¶</button>
        <button class="btn btn-outline btn-lg" onclick="showInstantModal()">&#x2795; å…¶ä»–</button>
      </div>
    </div>
    <div class="card" id="lastInstantCard" style="display: none;">
      <div style="font-size: 14px; color: #999;">ä¸Šæ¬¡æ¢å°¿è£¤</div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
        <div>
          <span class="time-ago" id="lastDiaperAgo">--</span>
          <span style="font-size: 13px; color: #999;">å‰</span>
        </div>
        <div>
          <span class="record-time" id="lastDiaperTime">--</span>
          <span class="record-by" id="lastDiaperBy">--</span>
        </div>
      </div>
    </div>
    <div id="instantRecords">
      <div class="empty-state"><div class="empty-icon">&#x1F4CB;</div><div class="empty-text">æš‚æ— è®°å½•</div></div>
    </div>
  </div>

  <!-- æŒç»­æ—¶é—´è®°å½•é¡µ -->
  <div class="page" id="durationPage">
    <div class="header" id="durationHeader">
      &#x1F476; <span id="durationTitle">å°è®°å½•</span>
      <small>è®°å½•æœ‰æ—¶é•¿çš„æ´»åŠ¨</small>
      <span class="user-badge" id="durationBadge" onclick="toggleSettings('durationSettings')"></span>
      <div class="settings-popup" id="durationSettings">
        <div class="settings-popup-item" onclick="logout()">é€€å‡ºç™»å½•</div>
      </div>
    </div>
    <div id="activeEventsSection" style="display: none;">
      <div style="font-size: 14px; color: #999; margin-bottom: 8px;">&#x1F534; è¿›è¡Œä¸­</div>
      <div id="activeEventsList"></div>
    </div>
    <div class="card" style="text-align: center;">
      <div style="font-size: 14px; color: #999; margin-bottom: 12px;">å¼€å§‹æ–°æ´»åŠ¨</div>
      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-primary btn-lg" onclick="startDuration('sunbath', 'æ™’å¤ªé˜³')">&#x2600;&#xFE0F; æ™’å¤ªé˜³</button>
        <button class="btn btn-success btn-lg" onclick="startDuration('breastfeed', 'åƒå¥¶')">&#x1F37C; åƒå¥¶</button>
        <button class="btn btn-outline btn-lg" onclick="showDurationModal()">&#x2795; å…¶ä»–</button>
      </div>
    </div>
    <div id="durationRecords">
      <div class="empty-state"><div class="empty-icon">&#x1F4CB;</div><div class="empty-text">æš‚æ— è®°å½•</div></div>
    </div>
  </div>

  <!-- å†å²é¡µ -->
  <div class="page" id="historyPage">
    <div class="header">&#x1F4C5; å†å²è®°å½•</div>
    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
      <button class="tag selected" onclick="filterHistory('all', this)">å…¨éƒ¨</button>
      <button class="tag" onclick="filterHistory('diaper', this)">æ¢å°¿è£¤</button>
      <button class="tag" onclick="filterHistory('sunbath', this)">æ™’å¤ªé˜³</button>
      <button class="tag" onclick="filterHistory('feed', this)">å–‚å¥¶</button>
      <button class="tag" onclick="filterHistory('breastfeed', this)">åƒå¥¶</button>
    </div>
    <div id="historyList"></div>
  </div>

</div>

<!-- åº•éƒ¨å¯¼èˆª -->
<div class="bottom-nav" id="bottomNav" style="display: none;">
  <div class="nav-item active" onclick="switchTab('instant')">
    <span class="nav-icon">&#x23F0;</span><span>æ—¶é—´ç‚¹</span>
  </div>
  <div class="nav-item" onclick="switchTab('duration')">
    <span class="nav-icon">&#x23F1;&#xFE0F;</span><span>æŒç»­</span>
  </div>
  <div class="nav-item" onclick="switchTab('history')">
    <span class="nav-icon">&#x1F4C5;</span><span>å†å²</span>
  </div>
</div>

<!-- äº‹ä»¶é€‰æ‹©å¼¹çª— - æ—¶é—´ç‚¹ -->
<div class="modal-overlay" id="instantModal">
  <div class="modal">
    <div class="modal-title">é€‰æ‹©äº‹ä»¶ç±»å‹</div>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
      <button class="btn btn-primary" onclick="quickInstant('diaper', 'æ¢å°¿è£¤'); closeModal('instantModal')">&#x1F9F7; æ¢å°¿è£¤</button>
      <button class="btn btn-success" onclick="quickInstant('feed', 'å–‚å¥¶'); closeModal('instantModal')">&#x1F37C; å–‚å¥¶</button>
      <button class="btn btn-outline" onclick="quickInstant('poop', 'æ‹‰ä¾¿ä¾¿'); closeModal('instantModal')">&#x1F4A9; æ‹‰ä¾¿ä¾¿</button>
      <button class="btn btn-outline" onclick="quickInstant('bath', 'æ´—æ¾¡'); closeModal('instantModal')">&#x1F6C1; æ´—æ¾¡</button>
      <button class="btn btn-outline" onclick="quickInstant('sleep', 'å…¥ç¡'); closeModal('instantModal')">&#x1F634; å…¥ç¡</button>
      <button class="btn btn-outline" onclick="quickInstant('wake', 'é†’æ¥'); closeModal('instantModal')">&#x1F31E; é†’æ¥</button>
      <button class="btn btn-outline" onclick="quickInstant('medicine', 'åƒè¯'); closeModal('instantModal')">&#x1F48A; åƒè¯</button>
    </div>
    <button class="btn btn-block" style="margin-top: 16px; background: #f5f5f5; color: #999;" onclick="closeModal('instantModal')">å–æ¶ˆ</button>
  </div>
</div>

<!-- äº‹ä»¶é€‰æ‹©å¼¹çª— - æŒç»­ -->
<div class="modal-overlay" id="durationModal">
  <div class="modal">
    <div class="modal-title">é€‰æ‹©æ´»åŠ¨ç±»å‹</div>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
      <button class="btn btn-primary" onclick="startDuration('sunbath', 'æ™’å¤ªé˜³'); closeModal('durationModal')">&#x2600;&#xFE0F; æ™’å¤ªé˜³</button>
      <button class="btn btn-success" onclick="startDuration('breastfeed', 'åƒå¥¶'); closeModal('durationModal')">&#x1F37C; åƒå¥¶</button>
      <button class="btn btn-outline" onclick="startDuration('tummy', 'è¶´è¶´æ—¶é—´'); closeModal('durationModal')">&#x1F476; è¶´è¶´æ—¶é—´</button>
      <button class="btn btn-outline" onclick="startDuration('play', 'ç©è€'); closeModal('durationModal')">&#x1F3A8; ç©è€</button>
      <button class="btn btn-outline" onclick="startDuration('nap', 'å°ç¡'); closeModal('durationModal')">&#x1F634; å°ç¡</button>
      <button class="btn btn-outline" onclick="startDuration('walk', 'æˆ·å¤–æ•£æ­¥'); closeModal('durationModal')">&#x1F6B6; æˆ·å¤–æ•£æ­¥</button>
    </div>
    <button class="btn btn-block" style="margin-top: 16px; background: #f5f5f5; color: #999;" onclick="closeModal('durationModal')">å–æ¶ˆ</button>
  </div>
</div>

<!-- ä¿®æ”¹äº‹ä»¶å¼¹çª— -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">ä¿®æ”¹æ´»åŠ¨ç±»å‹</div>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;" id="editEventOptions"></div>
    <button class="btn btn-block" style="margin-top: 16px; background: #f5f5f5; color: #999;" onclick="closeModal('editModal')">å–æ¶ˆ</button>
  </div>
</div>

<script>
// ===== å…¨å±€çŠ¶æ€ =====
var API = '';
var TOKEN = localStorage.getItem('xjl_token') || '';
var USER = localStorage.getItem('xjl_user') || '';
var BABY_NAME = localStorage.getItem('xjl_babyName') || '';
var activeTimers = {};
var refreshInterval = null;
var pendingUpload = { type: '', id: 0 };
var previewingImgId = 0;
var editingId = null;
var historyFilter = 'all';

// ===== API å°è£… =====
function api(method, path, body) {
  var opts = { method: method, headers: { 'Content-Type': 'application/json', 'x-auth-token': TOKEN } };
  if (body) opts.body = JSON.stringify(body);
  return fetch(API + path, opts).then(function(res) {
    if (res.status === 401) { logout(); throw new Error('æœªè®¤è¯'); }
    return res.json();
  });
}

// ===== ç™»å½•é€»è¾‘ =====
document.getElementById('passwordInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    var pwd = this.value;
    var self = this;
    fetch(API + '/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pwd })
    }).then(function(res) { return res.json(); }).then(function(data) {
      if (data.success) {
        TOKEN = data.token;
        BABY_NAME = data.babyName || '';
        localStorage.setItem('xjl_token', TOKEN);
        localStorage.setItem('xjl_babyName', BABY_NAME);
        document.getElementById('loginStep2').style.display = 'block';
        self.style.display = 'none';
        document.getElementById('loginError').textContent = '';
      } else {
        document.getElementById('loginError').textContent = 'å¯†ç ä¸å¯¹å“¦ï½';
      }
    }).catch(function() {
      document.getElementById('loginError').textContent = 'ç½‘ç»œé”™è¯¯';
    });
  }
});

function selectIdentity(name, el) {
  document.querySelectorAll('.identity-btn').forEach(function(b) { b.classList.remove('selected'); });
  el.classList.add('selected');
  USER = name;
  localStorage.setItem('xjl_user', USER);
  setTimeout(function() { enterApp(); }, 300);
}

function enterApp() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('bottomNav').style.display = 'flex';
  updateHeaders();
  loadData();
  refreshInterval = setInterval(loadData, 15000);
}

function updateHeaders() {
  var title = BABY_NAME ? (BABY_NAME + 'çš„å°è®°å½•') : 'å°è®°å½•';
  document.getElementById('instantTitle').textContent = title;
  document.getElementById('durationTitle').textContent = title;
  document.getElementById('instantBadge').textContent = USER;
  document.getElementById('durationBadge').textContent = USER;
}

function logout() {
  TOKEN = '';
  USER = '';
  BABY_NAME = '';
  localStorage.removeItem('xjl_token');
  localStorage.removeItem('xjl_user');
  localStorage.removeItem('xjl_babyName');
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('bottomNav').style.display = 'none';
  document.getElementById('loginStep2').style.display = 'none';
  document.getElementById('passwordInput').style.display = 'block';
  document.getElementById('passwordInput').value = '';
  document.getElementById('activeBanner').classList.remove('show');
  document.body.classList.remove('has-banner');
  if (refreshInterval) clearInterval(refreshInterval);
  Object.values(activeTimers).forEach(function(t) { clearInterval(t); });
  activeTimers = {};
}

// è‡ªåŠ¨ç™»å½•
if (TOKEN && USER) {
  api('GET', '/api/active').then(function() { enterApp(); }).catch(function() { logout(); });
}

// ===== é¡µé¢åˆ‡æ¢ =====
function switchTab(tab) {
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
  var tabMap = { instant: 0, duration: 1, history: 2 };
  document.getElementById(tab + 'Page').classList.add('active');
  document.querySelectorAll('.nav-item')[tabMap[tab]].classList.add('active');
  if (tab === 'history') loadHistory();
}

// ===== è®¾ç½®å¼¹çª— =====
function toggleSettings(id) {
  var el = document.getElementById(id);
  var isShow = el.classList.contains('show');
  document.querySelectorAll('.settings-popup').forEach(function(p) { p.classList.remove('show'); });
  if (!isShow) el.classList.add('show');
}
document.addEventListener('click', function(e) {
  if (!e.target.classList.contains('user-badge')) {
    document.querySelectorAll('.settings-popup').forEach(function(p) { p.classList.remove('show'); });
  }
});

// ===== æ•°æ®åŠ è½½ =====
function loadData() {
  Promise.all([
    api('GET', '/api/recent?days=10'),
    api('GET', '/api/active')
  ]).then(function(results) {
    var data = results[0];
    var active = results[1];
    renderInstantList(data.instants);
    renderDurationList(data.durations, active);
    renderActiveBanner(active);
    updateLastDiaper(data.instants);
  }).catch(function(err) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', err);
  });
}

// ===== æ—¥æœŸåˆ†ç»„å·¥å…· =====
function getDateKey(isoStr) {
  var d = new Date(isoStr);
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

function getDateLabel(dateKey) {
  var today = new Date();
  var todayKey = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
  var yest = new Date(today);
  yest.setDate(yest.getDate() - 1);
  var yestKey = yest.getFullYear() + '-' + String(yest.getMonth() + 1).padStart(2, '0') + '-' + String(yest.getDate()).padStart(2, '0');
  if (dateKey === todayKey) return 'ä»Šå¤©';
  if (dateKey === yestKey) return 'æ˜¨å¤©';
  var parts = dateKey.split('-');
  return parseInt(parts[1]) + 'æœˆ' + parseInt(parts[2]) + 'æ—¥';
}

function groupByDate(records, timeField) {
  var groups = {};
  var order = [];
  records.forEach(function(r) {
    var key = getDateKey(r[timeField]);
    if (!groups[key]) { groups[key] = []; order.push(key); }
    groups[key].push(r);
  });
  return { groups: groups, order: order };
}

// ===== å›¾ç‰‡ç¼©ç•¥å›¾æ¸²æŸ“ =====
function renderThumbs(images, recordType, recordId) {
  var html = '<div class="record-images">';
  if (images && images.length > 0) {
    images.forEach(function(img) {
      html += '<div class="img-thumb-wrap">';
      html += '<img src="' + img.url + '" onclick="previewImage(' + img.id + ', \'' + img.url + '\')">';
      html += '</div>';
    });
  }
  html += '<div class="img-upload-btn" onclick="triggerUpload(\'' + recordType + '\', ' + recordId + ')">+</div>';
  html += '</div>';
  return html;
}

// ===== å›¾ç‰‡ä¸Šä¼  =====
function triggerUpload(type, id) {
  pendingUpload.type = type;
  pendingUpload.id = id;
  document.getElementById('imageInput').value = '';
  document.getElementById('imageInput').click();
}

function handleImageSelected(input) {
  if (!input.files || !input.files[0]) return;
  var file = input.files[0];
  compressImage(file).then(function(blob) {
    var fd = new FormData();
    fd.append('image', blob, 'photo.jpg');
    fd.append('record_type', pendingUpload.type);
    fd.append('record_id', pendingUpload.id);
    return fetch(API + '/api/upload', {
      method: 'POST',
      headers: { 'x-auth-token': TOKEN },
      body: fd
    });
  }).then(function(res) { return res.json(); }).then(function(data) {
    if (data.success) {
      showToast('å›¾ç‰‡å·²ä¸Šä¼  âœ“');
      loadData();
    }
  }).catch(function(err) {
    showToast('ä¸Šä¼ å¤±è´¥');
    console.error(err);
  });
}

function compressImage(file) {
  return new Promise(function(resolve) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var img = new Image();
      img.onload = function() {
        var canvas = document.createElement('canvas');
        var maxDim = 1200;
        var w = img.width;
        var h = img.height;
        if (w > maxDim || h > maxDim) {
          if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
          else { w = Math.round(w * maxDim / h); h = maxDim; }
        }
        canvas.width = w;
        canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        canvas.toBlob(function(blob) { resolve(blob); }, 'image/jpeg', 0.7);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// ===== å›¾ç‰‡é¢„è§ˆ =====
function previewImage(imgId, url) {
  previewingImgId = imgId;
  document.getElementById('imgPreviewSrc').src = url;
  document.getElementById('imgPreview').classList.add('show');
}

function closeImgPreview() {
  document.getElementById('imgPreview').classList.remove('show');
  previewingImgId = 0;
}

function deletePreviewImage() {
  if (!previewingImgId) return;
  if (!confirm('ç¡®å®šåˆ é™¤è¿™å¼ å›¾ç‰‡ï¼Ÿ')) return;
  api('DELETE', '/api/images/' + previewingImgId).then(function() {
    closeImgPreview();
    showToast('å›¾ç‰‡å·²åˆ é™¤');
    loadData();
  });
}

// ===== æ—¶é—´ç‚¹è®°å½• =====
function quickInstant(type, label) {
  var now = new Date();
  var localISO = toLocalISO(now);
  api('POST', '/api/instant', {
    event_type: type,
    event_label: label,
    recorded_by: USER,
    recorded_at: localISO
  }).then(function() {
    showToast('å·²è®°å½• ' + label + ' âœ“');
    loadData();
  });
}

function renderInstantList(records) {
  var el = document.getElementById('instantRecords');
  if (!records || records.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">&#x1F4CB;</div><div class="empty-text">æš‚æ— è®°å½•</div></div>';
    return;
  }
  var grouped = groupByDate(records, 'recorded_at');
  var html = '';
  grouped.order.forEach(function(dateKey) {
    var label = getDateLabel(dateKey);
    var items = grouped.groups[dateKey];
    html += '<div class="card"><div class="date-group-title">' + label + '</div>';
    items.forEach(function(r) {
      html += '<div class="record-item">';
      html += '<div class="record-main">';
      html += '<div>';
      html += '<div style="font-size:15px;font-weight:600">' + getEmoji(r.event_type) + ' ' + r.event_label + '</div>';
      html += '<div class="record-time">' + formatTime(r.recorded_at) + ' Â· <span class="record-by">' + r.recorded_by + '</span></div>';
      html += '</div>';
      html += '<div style="display:flex;align-items:center;gap:8px">';
      html += '<span style="font-size:13px;color:#E91E63">' + timeAgo(r.recorded_at) + '</span>';
      html += '<span class="delete-btn" onclick="deleteInstant(' + r.id + ')">Ã—</span>';
      html += '</div>';
      html += '</div>';
      html += renderThumbs(r.images, 'instant', r.id);
      html += '</div>';
    });
    html += '</div>';
  });
  el.innerHTML = html;
}

function updateLastDiaper(records) {
  var diaper = null;
  for (var i = 0; i < records.length; i++) {
    if (records[i].event_type === 'diaper') { diaper = records[i]; break; }
  }
  var card = document.getElementById('lastInstantCard');
  if (diaper) {
    card.style.display = 'block';
    document.getElementById('lastDiaperAgo').textContent = timeAgo(diaper.recorded_at);
    document.getElementById('lastDiaperTime').textContent = formatTime(diaper.recorded_at) + ' ';
    document.getElementById('lastDiaperBy').textContent = diaper.recorded_by;
  } else {
    card.style.display = 'none';
  }
}

function deleteInstant(id) {
  if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) return;
  api('DELETE', '/api/instant/' + id).then(function() { loadData(); });
}

// ===== æŒç»­æ—¶é—´è®°å½• =====
function startDuration(type, label) {
  var now = new Date();
  var localISO = toLocalISO(now);
  api('POST', '/api/duration/start', {
    event_type: type,
    event_label: label,
    started_by: USER,
    started_at: localISO
  }).then(function() {
    showToast(label + ' å¼€å§‹è®¡æ—¶ â–¶');
    loadData();
  });
}

function endDuration(id) {
  api('POST', '/api/duration/end/' + id, { ended_by: USER }).then(function() {
    showToast('å·²ç»“æŸ âœ“');
    loadData();
  });
}

function renderDurationList(allRecords, activeRecords) {
  var activeSection = document.getElementById('activeEventsSection');
  var activeList = document.getElementById('activeEventsList');
  if (activeRecords && activeRecords.length > 0) {
    activeSection.style.display = 'block';
    activeList.innerHTML = activeRecords.map(function(r) {
      var elapsed = getElapsedMinutes(r.started_at);
      return '<div class="card active-event">' +
        '<div style="display:flex;justify-content:space-between;align-items:center">' +
        '<div>' +
        '<div style="font-size:16px;font-weight:700">' + getEmoji(r.event_type) + ' ' + r.event_label + '</div>' +
        '<div class="record-time">' + formatTime(r.started_at) + ' å¼€å§‹ Â· ' + r.started_by + '</div>' +
        '</div>' +
        '<div style="text-align:right"><div class="timer" id="timer-' + r.id + '">' + formatDuration(elapsed) + '</div></div>' +
        '</div>' +
        '<div style="display:flex;gap:8px;margin-top:12px">' +
        '<button class="btn btn-danger btn-block" onclick="endDuration(' + r.id + ')">â¹ ç»“æŸ</button>' +
        '<button class="btn btn-outline" onclick="showEditModal(' + r.id + ')" style="flex-shrink:0">âœï¸</button>' +
        '</div>' +
        renderThumbs(r.images || [], 'duration', r.id) +
        '</div>';
    }).join('');
    startTimers(activeRecords);
  } else {
    activeSection.style.display = 'none';
    activeList.innerHTML = '';
  }

  var completed = allRecords.filter(function(r) { return r.ended_at; });
  var el = document.getElementById('durationRecords');
  if (completed.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">&#x1F4CB;</div><div class="empty-text">æš‚æ— å®Œæˆçš„æ´»åŠ¨</div></div>';
    return;
  }
  var grouped = groupByDate(completed, 'started_at');
  var html = '';
  grouped.order.forEach(function(dateKey) {
    var label = getDateLabel(dateKey);
    var items = grouped.groups[dateKey];
    html += '<div class="card"><div class="date-group-title">' + label + '</div>';
    items.forEach(function(r) {
      html += '<div class="record-item">';
      html += '<div class="record-main">';
      html += '<div>';
      html += '<div style="font-size:15px;font-weight:600">' + getEmoji(r.event_type) + ' ' + r.event_label + '</div>';
      html += '<div class="record-time">' + formatTime(r.started_at) + ' â†’ ' + formatTime(r.ended_at) + '</div>';
      html += '<div class="record-time">' + r.started_by + 'å¼€å§‹ Â· ' + r.ended_by + 'ç»“æŸ</div>';
      html += '</div>';
      html += '<div style="text-align:right">';
      html += '<div style="font-size:18px;font-weight:700;color:#4CAF50">' + formatDuration(r.duration_minutes) + '</div>';
      html += '<span class="delete-btn" onclick="deleteDuration(' + r.id + ')">Ã—</span>';
      html += '</div>';
      html += '</div>';
      html += renderThumbs(r.images, 'duration', r.id);
      html += '</div>';
    });
    html += '</div>';
  });
  el.innerHTML = html;
}

function startTimers(activeRecords) {
  Object.keys(activeTimers).forEach(function(k) {
    if (k !== 'banner') clearInterval(activeTimers[k]);
  });
  activeRecords.forEach(function(r) {
    activeTimers[r.id] = setInterval(function() {
      var el = document.getElementById('timer-' + r.id);
      if (el) el.textContent = formatDuration(getElapsedMinutes(r.started_at));
    }, 1000);
  });
}

function renderActiveBanner(active) {
  var banner = document.getElementById('activeBanner');
  if (active && active.length > 0) {
    banner.classList.add('show');
    document.body.classList.add('has-banner');
    var r = active[0];
    var updateBanner = function() {
      var elapsed = getElapsedMinutes(r.started_at);
      document.getElementById('bannerText').innerHTML =
        getEmoji(r.event_type) + ' ' + r.event_label + ' è¿›è¡Œä¸­ <span class="banner-timer">' + formatDuration(elapsed) + '</span>';
    };
    updateBanner();
    if (activeTimers['banner']) clearInterval(activeTimers['banner']);
    activeTimers['banner'] = setInterval(updateBanner, 1000);
  } else {
    banner.classList.remove('show');
    document.body.classList.remove('has-banner');
    if (activeTimers['banner']) { clearInterval(activeTimers['banner']); delete activeTimers['banner']; }
  }
}

function deleteDuration(id) {
  if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) return;
  api('DELETE', '/api/duration/' + id).then(function() { loadData(); });
}

// ===== ä¿®æ”¹äº‹ä»¶ç±»å‹ =====
function showEditModal(id) {
  editingId = id;
  var types = [
    ['sunbath', 'â˜€ï¸ æ™’å¤ªé˜³'], ['breastfeed', 'ğŸ¼ åƒå¥¶'], ['tummy', 'ğŸ‘¶ è¶´è¶´æ—¶é—´'],
    ['play', 'ğŸ¨ ç©è€'], ['nap', 'ğŸ˜´ å°ç¡'], ['walk', 'ğŸš¶ æˆ·å¤–æ•£æ­¥']
  ];
  document.getElementById('editEventOptions').innerHTML = types.map(function(t) {
    return '<button class="btn btn-outline" onclick="editDuration(\'' + t[0] + '\', \'' + t[1].slice(2) + '\')">' + t[1] + '</button>';
  }).join('');
  document.getElementById('editModal').classList.add('show');
}

function editDuration(type, label) {
  api('PUT', '/api/duration/' + editingId, { event_type: type, event_label: label }).then(function() {
    closeModal('editModal');
    showToast('å·²ä¿®æ”¹ âœ“');
    loadData();
  });
}

// ===== å†å²è®°å½• =====
function loadHistory() {
  Promise.all([
    api('GET', '/api/instant?limit=100'),
    api('GET', '/api/duration?limit=100')
  ]).then(function(results) {
    renderHistory(results[0], results[1]);
  }).catch(function(e) {
    console.error('åŠ è½½å†å²å¤±è´¥:', e);
  });
}

function filterHistory(type, el) {
  document.querySelectorAll('#historyPage .tag').forEach(function(t) { t.classList.remove('selected'); });
  el.classList.add('selected');
  historyFilter = type;
  loadHistory();
}

function renderHistory(instants, durations) {
  var list = document.getElementById('historyList');
  var all = [];
  instants.forEach(function(r) {
    if (historyFilter !== 'all' && r.event_type !== historyFilter) return;
    all.push({ time: r.recorded_at, html:
      '<div class="record-item"><div><div style="font-weight:600">' + getEmoji(r.event_type) + ' ' + r.event_label + '</div>' +
      '<div class="record-time">' + formatDate(r.recorded_at) + ' ' + formatTime(r.recorded_at) + ' Â· ' + r.recorded_by + '</div>' +
      '</div><span class="delete-btn" onclick="deleteInstant(' + r.id + ')">Ã—</span></div>'
    });
  });
  durations.forEach(function(r) {
    if (historyFilter !== 'all' && r.event_type !== historyFilter) return;
    var status = r.ended_at ? '(' + formatDuration(r.duration_minutes) + ')' : '<span style="color:#E91E63">è¿›è¡Œä¸­</span>';
    var timeRange = formatTime(r.started_at) + (r.ended_at ? ' â†’ ' + formatTime(r.ended_at) : '');
    var who = r.started_by + (r.ended_by ? ' â†’ ' + r.ended_by : '');
    all.push({ time: r.started_at, html:
      '<div class="record-item"><div><div style="font-weight:600">' + getEmoji(r.event_type) + ' ' + r.event_label + ' ' + status + '</div>' +
      '<div class="record-time">' + formatDate(r.started_at) + ' ' + timeRange + '</div>' +
      '<div class="record-time">' + who + '</div>' +
      '</div><span class="delete-btn" onclick="deleteDuration(' + r.id + ')">Ã—</span></div>'
    });
  });
  all.sort(function(a, b) { return new Date(b.time) - new Date(a.time); });
  if (all.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">&#x1F4CB;</div><div class="empty-text">æš‚æ— å†å²è®°å½•</div></div>';
    return;
  }
  var groups = {};
  var order = [];
  all.forEach(function(item) {
    var date = formatDate(item.time);
    if (!groups[date]) { groups[date] = []; order.push(date); }
    groups[date].push(item.html);
  });
  list.innerHTML = order.map(function(date) {
    return '<div class="card"><div style="font-size:14px;font-weight:600;color:#999;margin-bottom:8px">' + date + '</div>' + groups[date].join('') + '</div>';
  }).join('');
}

// ===== å¼¹çª— =====
function showInstantModal() { document.getElementById('instantModal').classList.add('show'); }
function showDurationModal() { document.getElementById('durationModal').classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
  overlay.addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('show');
  });
});

// ===== Toast =====
function showToast(msg) {
  var toast = document.createElement('div');
  toast.textContent = msg;
  toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.75);color:white;padding:12px 24px;border-radius:12px;font-size:15px;font-weight:600;z-index:999';
  document.body.appendChild(toast);
  setTimeout(function() { toast.remove(); }, 1500);
}

// ===== å·¥å…·å‡½æ•° =====
function toLocalISO(date) {
  var offset = date.getTimezoneOffset();
  var local = new Date(date.getTime() - offset * 60000);
  return local.toISOString().slice(0, -1);
}

function formatTime(isoStr) {
  var d = new Date(isoStr);
  return String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
}

function formatDate(isoStr) {
  var d = new Date(isoStr);
  return (d.getMonth() + 1) + 'æœˆ' + d.getDate() + 'æ—¥';
}

function timeAgo(isoStr) {
  var now = new Date();
  var then = new Date(isoStr);
  var mins = Math.floor((now - then) / 60000);
  if (mins < 1) return 'åˆšåˆš';
  if (mins < 60) return mins + 'åˆ†é’Ÿ';
  var hours = Math.floor(mins / 60);
  var rm = mins % 60;
  if (hours < 24) return rm > 0 ? hours + 'å°æ—¶' + rm + 'åˆ†é’Ÿ' : hours + 'å°æ—¶';
  return Math.floor(hours / 24) + 'å¤©';
}

function formatDuration(minutes) {
  if (minutes < 1) return Math.round(minutes * 60) + 'ç§’';
  var h = Math.floor(minutes / 60);
  var m = Math.floor(minutes % 60);
  if (h > 0) return h + 'æ—¶' + m + 'åˆ†';
  return m + 'åˆ†é’Ÿ';
}

function getElapsedMinutes(startISO) {
  return (new Date() - new Date(startISO)) / 60000;
}

function getEmoji(type) {
  var map = {
    diaper: 'ğŸ§·', feed: 'ğŸ¼', breastfeed: 'ğŸ¼', sunbath: 'â˜€ï¸',
    poop: 'ğŸ’©', bath: 'ğŸ›', sleep: 'ğŸ˜´', wake: 'ğŸŒ',
    medicine: 'ğŸ’Š', tummy: 'ğŸ‘¶', play: 'ğŸ¨', nap: 'ğŸ˜´', walk: 'ğŸš¶'
  };
  return map[type] || 'ğŸ“';
}

// ===== Service Worker =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(function() {});
}
</script>
</body>
</html>
