<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="å°è®°å½•">
  <meta name="theme-color" content="#FFB6C1">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon.svg">
  <title>å°è®°å½•</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #FFF5F5;
      color: #333;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== é€šç”¨ ===== */
    .page { display: none; padding: 16px; padding-bottom: 80px; max-width: 500px; margin: 0 auto; }
    .page.active { display: block; }
    .header { 
      text-align: center; padding: 20px 0 16px;
      font-size: 22px; font-weight: 700; color: #E91E63;
    }
    .header small { display: block; font-size: 13px; color: #999; font-weight: 400; margin-top: 4px; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 12px 24px; border: none; border-radius: 12px;
      font-size: 16px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; -webkit-tap-highlight-color: transparent;
    }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: #E91E63; color: white; }
    .btn-primary:active { background: #C2185B; }
    .btn-success { background: #4CAF50; color: white; }
    .btn-success:active { background: #388E3C; }
    .btn-danger { background: #f44336; color: white; }
    .btn-danger:active { background: #D32F2F; }
    .btn-outline { background: white; color: #E91E63; border: 2px solid #E91E63; }
    .btn-block { display: flex; width: 100%; }
    .btn-lg { padding: 16px 32px; font-size: 18px; border-radius: 16px; }

    .card {
      background: white; border-radius: 16px; padding: 16px;
      margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .input {
      width: 100%; padding: 14px 16px; border: 2px solid #eee;
      border-radius: 12px; font-size: 16px; outline: none;
      transition: border-color 0.2s;
    }
    .input:focus { border-color: #E91E63; }

    .tag {
      display: inline-flex; align-items: center; padding: 8px 16px;
      border-radius: 20px; font-size: 14px; font-weight: 500;
      margin: 4px; cursor: pointer; transition: all 0.2s;
      border: 2px solid #eee; background: white; color: #666;
    }
    .tag.selected { border-color: #E91E63; background: #FFF0F5; color: #E91E63; }
    .tag:active { transform: scale(0.95); }

    .time-ago { color: #E91E63; font-weight: 600; }
    .record-time { color: #999; font-size: 13px; }
    .record-by { 
      display: inline-block; padding: 2px 8px; border-radius: 10px;
      font-size: 12px; background: #FFF0F5; color: #E91E63;
    }
    .record-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid #f5f5f5;
    }
    .record-item:last-child { border-bottom: none; }

    .active-event {
      background: linear-gradient(135deg, #FFF0F5, #FFE0EC);
      border: 2px solid #E91E63; animation: pulse-border 2s infinite;
    }
    @keyframes pulse-border {
      0%, 100% { border-color: #E91E63; }
      50% { border-color: #F48FB1; }
    }

    .timer { font-size: 28px; font-weight: 700; color: #E91E63; font-variant-numeric: tabular-nums; }

    /* ===== åº•éƒ¨å¯¼èˆª ===== */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: white; display: flex; justify-content: space-around;
      padding: 8px 0 env(safe-area-inset-bottom, 8px);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
      z-index: 100;
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center;
      padding: 4px 12px; cursor: pointer; color: #999;
      font-size: 11px; transition: color 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .nav-item.active { color: #E91E63; }
    .nav-item .nav-icon { font-size: 24px; margin-bottom: 2px; }

    /* ===== è¿›è¡Œä¸­äº‹ä»¶æ¨ªå¹… ===== */
    .active-banner {
      display: none; position: fixed; top: 0; left: 0; right: 0;
      background: linear-gradient(135deg, #E91E63, #FF5722);
      color: white; padding: 10px 16px; z-index: 200;
      font-size: 14px; text-align: center; cursor: pointer;
    }
    .active-banner.show { display: block; }
    .active-banner .banner-timer { font-weight: 700; font-size: 16px; }

    /* ===== ç™»å½•é¡µ ===== */
    #loginPage { 
      display: flex; flex-direction: column; align-items: center; 
      justify-content: center; min-height: 100vh; padding: 32px;
    }
    .login-title { font-size: 48px; margin-bottom: 8px; }
    .login-subtitle { font-size: 20px; color: #E91E63; font-weight: 600; margin-bottom: 32px; }
    .identity-grid { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
    .identity-btn {
      display: flex; flex-direction: column; align-items: center;
      padding: 16px 24px; border: 2px solid #eee; border-radius: 16px;
      background: white; cursor: pointer; transition: all 0.2s;
      min-width: 90px;
    }
    .identity-btn:active { transform: scale(0.95); }
    .identity-btn.selected { border-color: #E91E63; background: #FFF0F5; }
    .identity-btn .identity-icon { font-size: 32px; margin-bottom: 4px; }
    .identity-btn .identity-name { font-size: 14px; font-weight: 600; color: #333; }

    /* ===== äº‹ä»¶é€‰æ‹©å¼¹çª— ===== */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4); z-index: 300;
      justify-content: center; align-items: flex-end;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: white; border-radius: 20px 20px 0 0; padding: 24px;
      width: 100%; max-width: 500px; max-height: 70vh; overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; text-align: center; }

    /* ===== åˆ é™¤æŒ‰é’® ===== */
    .delete-btn {
      color: #ccc; font-size: 18px; cursor: pointer; padding: 4px 8px;
    }
    .delete-btn:active { color: #f44336; }

    /* ===== ç©ºçŠ¶æ€ ===== */
    .empty-state { text-align: center; padding: 40px 20px; color: #ccc; }
    .empty-state .empty-icon { font-size: 48px; margin-bottom: 8px; }
    .empty-state .empty-text { font-size: 14px; }

    /* æœ‰ banner æ—¶çš„é¡µé¢åç§» */
    body.has-banner .page { padding-top: 56px; }
  </style>
</head>
<body>

<!-- ===== è¿›è¡Œä¸­äº‹ä»¶æ¨ªå¹… ===== -->
<div class="active-banner" id="activeBanner" onclick="switchTab('duration')">
  <span id="bannerText"></span>
</div>

<!-- ===== ç™»å½•é¡µ ===== -->
<div id="loginPage" style="display: flex;">
  <div class="login-title">&#x1F476;</div>
  <div class="login-subtitle">å°è®°å½•</div>
  <input class="input" id="passwordInput" type="password" placeholder="è¾“å…¥å¯†ç " 
         style="max-width: 280px; text-align: center;">
  <div id="loginStep2" style="display: none; text-align: center; margin-top: 20px;">
    <div style="font-size: 15px; color: #666; margin-bottom: 12px;">ä½ æ˜¯è°ï¼Ÿ</div>
    <div class="identity-grid">
      <div class="identity-btn" onclick="selectIdentity('çˆ¸çˆ¸', this)">
        <span class="identity-icon">&#x1F468;</span>
        <span class="identity-name">çˆ¸çˆ¸</span>
      </div>
      <div class="identity-btn" onclick="selectIdentity('å¦ˆå¦ˆ', this)">
        <span class="identity-icon">&#x1F469;</span>
        <span class="identity-name">å¦ˆå¦ˆ</span>
      </div>
      <div class="identity-btn" onclick="selectIdentity('å¥¶å¥¶', this)">
        <span class="identity-icon">&#x1F475;</span>
        <span class="identity-name">å¥¶å¥¶</span>
      </div>
    </div>
  </div>
  <div id="loginError" style="color: #f44336; font-size: 13px; margin-top: 12px;"></div>
</div>

<!-- ===== ä¸»åº”ç”¨ ===== -->
<div id="mainApp" style="display: none;">

  <!-- æ—¶é—´ç‚¹è®°å½•é¡µ -->
  <div class="page active" id="instantPage">
    <div class="header">
      &#x23F0; æ—¶é—´ç‚¹è®°å½•
      <small>è®°å½•ä¸€æ¬¡æ€§äº‹ä»¶ï¼Œå¦‚æ¢å°¿è£¤</small>
    </div>

    <!-- å¿«æ·è®°å½•æŒ‰é’® -->
    <div class="card" style="text-align: center;">
      <div style="font-size: 14px; color: #999; margin-bottom: 12px;">å¿«é€Ÿè®°å½•</div>
      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-primary btn-lg" onclick="quickInstant('diaper', 'æ¢å°¿è£¤')">
          &#x1F9F7; æ¢å°¿è£¤
        </button>
        <button class="btn btn-success btn-lg" onclick="quickInstant('feed', 'å–‚å¥¶')">
          &#x1F37C; å–‚å¥¶
        </button>
        <button class="btn btn-outline btn-lg" onclick="showInstantModal()">
          &#x2795; å…¶ä»–
        </button>
      </div>
    </div>

    <!-- ä¸Šæ¬¡è®°å½•è·ä»Š -->
    <div class="card" id="lastInstantCard" style="display: none;">
      <div style="font-size: 14px; color: #999;">ä¸Šæ¬¡æ¢å°¿è£¤</div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
        <div>
          <span class="time-ago" id="lastDiaperAgo">--</span>
          <span style="font-size: 13px; color: #999;">å‰</span>
        </div>
        <div>
          <span class="record-time" id="lastDiaperTime">--</span>
          <span class="record-by" id="lastDiaperBy">--</span>
        </div>
      </div>
    </div>

    <!-- ä»Šæ—¥è®°å½•åˆ—è¡¨ -->
    <div class="card">
      <div style="font-size: 14px; color: #999; margin-bottom: 8px;">ä»Šæ—¥è®°å½•</div>
      <div id="instantList">
        <div class="empty-state">
          <div class="empty-icon">&#x1F4CB;</div>
          <div class="empty-text">æš‚æ— è®°å½•</div>
        </div>
      </div>
    </div>
  </div>

  <!-- æŒç»­æ—¶é—´è®°å½•é¡µ -->
  <div class="page" id="durationPage">
    <div class="header">
      &#x23F1;&#xFE0F; æŒç»­è®°å½•
      <small>è®°å½•æœ‰æ—¶é•¿çš„æ´»åŠ¨ï¼Œå¦‚æ™’å¤ªé˜³</small>
    </div>

    <!-- è¿›è¡Œä¸­çš„äº‹ä»¶ -->
    <div id="activeEventsSection" style="display: none;">
      <div style="font-size: 14px; color: #999; margin-bottom: 8px;">&#x1F534; è¿›è¡Œä¸­</div>
      <div id="activeEventsList"></div>
    </div>

    <!-- å¼€å§‹æ–°äº‹ä»¶ -->
    <div class="card" style="text-align: center;">
      <div style="font-size: 14px; color: #999; margin-bottom: 12px;">å¼€å§‹æ–°æ´»åŠ¨</div>
      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-primary btn-lg" onclick="startDuration('sunbath', 'æ™’å¤ªé˜³')">
          &#x2600;&#xFE0F; æ™’å¤ªé˜³
        </button>
        <button class="btn btn-success btn-lg" onclick="startDuration('breastfeed', 'åƒå¥¶')">
          &#x1F37C; åƒå¥¶
        </button>
        <button class="btn btn-outline btn-lg" onclick="showDurationModal()">
          &#x2795; å…¶ä»–
        </button>
      </div>
    </div>

    <!-- ä»Šæ—¥å®Œæˆçš„è®°å½• -->
    <div class="card">
      <div style="font-size: 14px; color: #999; margin-bottom: 8px;">ä»Šæ—¥å·²å®Œæˆ</div>
      <div id="durationList">
        <div class="empty-state">
          <div class="empty-icon">&#x1F4CB;</div>
          <div class="empty-text">æš‚æ— è®°å½•</div>
        </div>
      </div>
    </div>
  </div>

  <!-- å†å²é¡µ -->
  <div class="page" id="historyPage">
    <div class="header">
      &#x1F4C5; å†å²è®°å½•
    </div>
    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
      <button class="tag selected" onclick="filterHistory('all', this)">å…¨éƒ¨</button>
      <button class="tag" onclick="filterHistory('diaper', this)">æ¢å°¿è£¤</button>
      <button class="tag" onclick="filterHistory('sunbath', this)">æ™’å¤ªé˜³</button>
      <button class="tag" onclick="filterHistory('feed', this)">å–‚å¥¶</button>
      <button class="tag" onclick="filterHistory('breastfeed', this)">åƒå¥¶</button>
    </div>
    <div id="historyList"></div>
  </div>

</div>

<!-- åº•éƒ¨å¯¼èˆª -->
<div class="bottom-nav" id="bottomNav" style="display: none;">
  <div class="nav-item active" onclick="switchTab('instant')">
    <span class="nav-icon">&#x23F0;</span>
    <span>æ—¶é—´ç‚¹</span>
  </div>
  <div class="nav-item" onclick="switchTab('duration')">
    <span class="nav-icon">&#x23F1;&#xFE0F;</span>
    <span>æŒç»­</span>
  </div>
  <div class="nav-item" onclick="switchTab('history')">
    <span class="nav-icon">&#x1F4C5;</span>
    <span>å†å²</span>
  </div>
</div>

<!-- ===== äº‹ä»¶é€‰æ‹©å¼¹çª— - æ—¶é—´ç‚¹ ===== -->
<div class="modal-overlay" id="instantModal">
  <div class="modal">
    <div class="modal-title">é€‰æ‹©äº‹ä»¶ç±»å‹</div>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
      <button class="btn btn-primary" onclick="quickInstant('diaper', 'æ¢å°¿è£¤'); closeModal('instantModal')">&#x1F9F7; æ¢å°¿è£¤</button>
      <button class="btn btn-success" onclick="quickInstant('feed', 'å–‚å¥¶'); closeModal('instantModal')">&#x1F37C; å–‚å¥¶</button>
      <button class="btn btn-outline" onclick="quickInstant('poop', 'æ‹‰ä¾¿ä¾¿'); closeModal('instantModal')">&#x1F4A9; æ‹‰ä¾¿ä¾¿</button>
      <button class="btn btn-outline" onclick="quickInstant('bath', 'æ´—æ¾¡'); closeModal('instantModal')">&#x1F6C1; æ´—æ¾¡</button>
      <button class="btn btn-outline" onclick="quickInstant('sleep', 'å…¥ç¡'); closeModal('instantModal')">&#x1F634; å…¥ç¡</button>
      <button class="btn btn-outline" onclick="quickInstant('wake', 'é†’æ¥'); closeModal('instantModal')">&#x1F31E; é†’æ¥</button>
      <button class="btn btn-outline" onclick="quickInstant('medicine', 'åƒè¯'); closeModal('instantModal')">&#x1F48A; åƒè¯</button>
    </div>
    <button class="btn btn-block" style="margin-top: 16px; background: #f5f5f5; color: #999;" onclick="closeModal('instantModal')">å–æ¶ˆ</button>
  </div>
</div>

<!-- ===== äº‹ä»¶é€‰æ‹©å¼¹çª— - æŒç»­ ===== -->
<div class="modal-overlay" id="durationModal">
  <div class="modal">
    <div class="modal-title">é€‰æ‹©æ´»åŠ¨ç±»å‹</div>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
      <button class="btn btn-primary" onclick="startDuration('sunbath', 'æ™’å¤ªé˜³'); closeModal('durationModal')">&#x2600;&#xFE0F; æ™’å¤ªé˜³</button>
      <button class="btn btn-success" onclick="startDuration('breastfeed', 'åƒå¥¶'); closeModal('durationModal')">&#x1F37C; åƒå¥¶</button>
      <button class="btn btn-outline" onclick="startDuration('tummy', 'è¶´è¶´æ—¶é—´'); closeModal('durationModal')">&#x1F476; è¶´è¶´æ—¶é—´</button>
      <button class="btn btn-outline" onclick="startDuration('play', 'ç©è€'); closeModal('durationModal')">&#x1F3A8; ç©è€</button>
      <button class="btn btn-outline" onclick="startDuration('nap', 'å°ç¡'); closeModal('durationModal')">&#x1F634; å°ç¡</button>
      <button class="btn btn-outline" onclick="startDuration('walk', 'æˆ·å¤–æ•£æ­¥'); closeModal('durationModal')">&#x1F6B6; æˆ·å¤–æ•£æ­¥</button>
    </div>
    <button class="btn btn-block" style="margin-top: 16px; background: #f5f5f5; color: #999;" onclick="closeModal('durationModal')">å–æ¶ˆ</button>
  </div>
</div>

<!-- ===== ä¿®æ”¹äº‹ä»¶å¼¹çª— ===== -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">ä¿®æ”¹æ´»åŠ¨ç±»å‹</div>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;" id="editEventOptions"></div>
    <button class="btn btn-block" style="margin-top: 16px; background: #f5f5f5; color: #999;" onclick="closeModal('editModal')">å–æ¶ˆ</button>
  </div>
</div>

<script>
// ===== å…¨å±€çŠ¶æ€ =====
const API = '';
let TOKEN = localStorage.getItem('xjl_token') || '';
let USER = localStorage.getItem('xjl_user') || '';
let activeTimers = {};
let refreshInterval = null;

// ===== API è¯·æ±‚å°è£… =====
async function api(method, path, body) {
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json', 'x-auth-token': TOKEN }
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API + path, opts);
  if (res.status === 401) { logout(); throw new Error('æœªè®¤è¯'); }
  return res.json();
}

// ===== ç™»å½•é€»è¾‘ =====
document.getElementById('passwordInput').addEventListener('keyup', async function(e) {
  if (e.key === 'Enter') {
    try {
      const res = await fetch(API + '/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: this.value })
      });
      const data = await res.json();
      if (data.success) {
        TOKEN = data.token;
        localStorage.setItem('xjl_token', TOKEN);
        document.getElementById('loginStep2').style.display = 'block';
        this.style.display = 'none';
        document.getElementById('loginError').textContent = '';
      } else {
        document.getElementById('loginError').textContent = 'å¯†ç ä¸å¯¹å“¦ï½';
      }
    } catch (err) {
      document.getElementById('loginError').textContent = 'ç½‘ç»œé”™è¯¯';
    }
  }
});

function selectIdentity(name, el) {
  document.querySelectorAll('.identity-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  USER = name;
  localStorage.setItem('xjl_user', USER);
  setTimeout(() => enterApp(), 300);
}

function enterApp() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('bottomNav').style.display = 'flex';
  loadData();
  refreshInterval = setInterval(loadData, 15000); // 15 ç§’è½®è¯¢
}

function logout() {
  TOKEN = '';
  USER = '';
  localStorage.removeItem('xjl_token');
  localStorage.removeItem('xjl_user');
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('bottomNav').style.display = 'none';
  document.getElementById('loginStep2').style.display = 'none';
  document.getElementById('passwordInput').style.display = 'block';
  document.getElementById('passwordInput').value = '';
  if (refreshInterval) clearInterval(refreshInterval);
}

// è‡ªåŠ¨ç™»å½•
if (TOKEN && USER) {
  api('GET', '/api/active').then(() => enterApp()).catch(() => logout());
} 

// ===== é¡µé¢åˆ‡æ¢ =====
function switchTab(tab) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const tabMap = { instant: 0, duration: 1, history: 2 };
  document.getElementById(tab + 'Page').classList.add('active');
  document.querySelectorAll('.nav-item')[tabMap[tab]].classList.add('active');
  if (tab === 'history') loadHistory();
}

// ===== æ•°æ®åŠ è½½ =====
async function loadData() {
  try {
    const [today, active] = await Promise.all([
      api('GET', '/api/today'),
      api('GET', '/api/active')
    ]);
    renderInstantList(today.instants);
    renderDurationList(today.durations, active);
    renderActiveBanner(active);
    updateLastDiaper(today.instants);
  } catch (err) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', err);
  }
}

// ===== æ—¶é—´ç‚¹è®°å½• =====
async function quickInstant(type, label) {
  const now = new Date();
  const localISO = toLocalISO(now);
  await api('POST', '/api/instant', {
    event_type: type,
    event_label: label,
    recorded_by: USER,
    recorded_at: localISO
  });
  showToast(`å·²è®°å½• ${label} âœ“`);
  loadData();
}

function renderInstantList(records) {
  const el = document.getElementById('instantList');
  if (!records || records.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">&#x1F4CB;</div><div class="empty-text">ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•</div></div>';
    return;
  }
  el.innerHTML = records.map(r => `
    <div class="record-item">
      <div>
        <div style="font-size: 15px; font-weight: 600;">${getEmoji(r.event_type)} ${r.event_label}</div>
        <div class="record-time">${formatTime(r.recorded_at)} Â· <span class="record-by">${r.recorded_by}</span></div>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 13px; color: #E91E63;">${timeAgo(r.recorded_at)}</span>
        <span class="delete-btn" onclick="deleteInstant(${r.id})">Ã—</span>
      </div>
    </div>
  `).join('');
}

function updateLastDiaper(records) {
  const diaper = records.find(r => r.event_type === 'diaper');
  const card = document.getElementById('lastInstantCard');
  if (diaper) {
    card.style.display = 'block';
    document.getElementById('lastDiaperAgo').textContent = timeAgo(diaper.recorded_at);
    document.getElementById('lastDiaperTime').textContent = formatTime(diaper.recorded_at) + ' ';
    document.getElementById('lastDiaperBy').textContent = diaper.recorded_by;
  } else {
    card.style.display = 'none';
  }
}

async function deleteInstant(id) {
  if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) return;
  await api('DELETE', `/api/instant/${id}`);
  loadData();
}

// ===== æŒç»­æ—¶é—´è®°å½• =====
async function startDuration(type, label) {
  const now = new Date();
  const localISO = toLocalISO(now);
  await api('POST', '/api/duration/start', {
    event_type: type,
    event_label: label,
    started_by: USER,
    started_at: localISO
  });
  showToast(`${label} å¼€å§‹è®¡æ—¶ â–¶`);
  loadData();
}

async function endDuration(id) {
  await api('POST', `/api/duration/end/${id}`, { ended_by: USER });
  showToast('å·²ç»“æŸ âœ“');
  loadData();
}

function renderDurationList(allRecords, activeRecords) {
  // è¿›è¡Œä¸­çš„
  const activeSection = document.getElementById('activeEventsSection');
  const activeList = document.getElementById('activeEventsList');
  
  if (activeRecords && activeRecords.length > 0) {
    activeSection.style.display = 'block';
    activeList.innerHTML = activeRecords.map(r => {
      const elapsed = getElapsedMinutes(r.started_at);
      return `
        <div class="card active-event">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 16px; font-weight: 700;">${getEmoji(r.event_type)} ${r.event_label}</div>
              <div class="record-time">${formatTime(r.started_at)} å¼€å§‹ Â· ${r.started_by}</div>
            </div>
            <div style="text-align: right;">
              <div class="timer" id="timer-${r.id}">${formatDuration(elapsed)}</div>
            </div>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button class="btn btn-danger btn-block" onclick="endDuration(${r.id})">â¹ ç»“æŸ</button>
            <button class="btn btn-outline" onclick="showEditModal(${r.id})" style="flex-shrink: 0;">âœï¸</button>
          </div>
        </div>
      `;
    }).join('');
    // å¯åŠ¨å®šæ—¶å™¨
    startTimers(activeRecords);
  } else {
    activeSection.style.display = 'none';
    activeList.innerHTML = '';
  }

  // å·²å®Œæˆçš„
  const completedRecords = allRecords.filter(r => r.ended_at);
  const durationList = document.getElementById('durationList');
  if (completedRecords.length === 0) {
    durationList.innerHTML = '<div class="empty-state"><div class="empty-icon">&#x1F4CB;</div><div class="empty-text">ä»Šå¤©è¿˜æ²¡æœ‰å®Œæˆçš„æ´»åŠ¨</div></div>';
    return;
  }
  durationList.innerHTML = completedRecords.map(r => `
    <div class="record-item">
      <div>
        <div style="font-size: 15px; font-weight: 600;">${getEmoji(r.event_type)} ${r.event_label}</div>
        <div class="record-time">${formatTime(r.started_at)} â†’ ${formatTime(r.ended_at)}</div>
        <div class="record-time">${r.started_by}å¼€å§‹ Â· ${r.ended_by}ç»“æŸ</div>
      </div>
      <div style="text-align: right;">
        <div style="font-size: 18px; font-weight: 700; color: #4CAF50;">${formatDuration(r.duration_minutes)}</div>
        <span class="delete-btn" onclick="deleteDuration(${r.id})">Ã—</span>
      </div>
    </div>
  `).join('');
}

function startTimers(activeRecords) {
  // æ¸…ç†æ—§å®šæ—¶å™¨
  Object.values(activeTimers).forEach(t => clearInterval(t));
  activeTimers = {};
  
  activeRecords.forEach(r => {
    activeTimers[r.id] = setInterval(() => {
      const el = document.getElementById(`timer-${r.id}`);
      if (el) {
        el.textContent = formatDuration(getElapsedMinutes(r.started_at));
      }
    }, 1000);
  });
}

function renderActiveBanner(active) {
  const banner = document.getElementById('activeBanner');
  if (active && active.length > 0) {
    banner.classList.add('show');
    document.body.classList.add('has-banner');
    const r = active[0];
    const updateBanner = () => {
      const elapsed = getElapsedMinutes(r.started_at);
      document.getElementById('bannerText').innerHTML = 
        `${getEmoji(r.event_type)} ${r.event_label} è¿›è¡Œä¸­ <span class="banner-timer">${formatDuration(elapsed)}</span>`;
    };
    updateBanner();
    if (activeTimers['banner']) clearInterval(activeTimers['banner']);
    activeTimers['banner'] = setInterval(updateBanner, 1000);
  } else {
    banner.classList.remove('show');
    document.body.classList.remove('has-banner');
  }
}

async function deleteDuration(id) {
  if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) return;
  await api('DELETE', `/api/duration/${id}`);
  loadData();
}

// ===== ä¿®æ”¹äº‹ä»¶ç±»å‹ =====
let editingId = null;
function showEditModal(id) {
  editingId = id;
  const types = [
    ['sunbath', 'â˜€ï¸ æ™’å¤ªé˜³'], ['breastfeed', 'ğŸ¼ åƒå¥¶'], ['tummy', 'ğŸ‘¶ è¶´è¶´æ—¶é—´'],
    ['play', 'ğŸ¨ ç©è€'], ['nap', 'ğŸ˜´ å°ç¡'], ['walk', 'ğŸš¶ æˆ·å¤–æ•£æ­¥']
  ];
  document.getElementById('editEventOptions').innerHTML = types.map(([type, label]) =>
    `<button class="btn btn-outline" onclick="editDuration('${type}', '${label.slice(2)}')">${label}</button>`
  ).join('');
  document.getElementById('editModal').classList.add('show');
}

async function editDuration(type, label) {
  await api('PUT', `/api/duration/${editingId}`, { event_type: type, event_label: label });
  closeModal('editModal');
  showToast('å·²ä¿®æ”¹ âœ“');
  loadData();
}

// ===== å†å²è®°å½• =====
let historyFilter = 'all';
async function loadHistory() {
  try {
    const [instants, durations] = await Promise.all([
      api('GET', '/api/instant?limit=50'),
      api('GET', '/api/duration?limit=50')
    ]);
    renderHistory(instants, durations);
  } catch(e) {
    console.error('åŠ è½½å†å²å¤±è´¥:', e);
  }
}

function filterHistory(type, el) {
  document.querySelectorAll('#historyPage .tag').forEach(t => t.classList.remove('selected'));
  el.classList.add('selected');
  historyFilter = type;
  loadHistory();
}

function renderHistory(instants, durations) {
  const list = document.getElementById('historyList');
  let all = [];
  
  instants.forEach(r => {
    if (historyFilter !== 'all' && r.event_type !== historyFilter) return;
    all.push({ time: r.recorded_at, html: `
      <div class="record-item">
        <div>
          <div style="font-weight: 600;">${getEmoji(r.event_type)} ${r.event_label}</div>
          <div class="record-time">${formatDate(r.recorded_at)} ${formatTime(r.recorded_at)} Â· ${r.recorded_by}</div>
        </div>
        <span class="delete-btn" onclick="deleteInstant(${r.id})">Ã—</span>
      </div>
    `});
  });
  
  durations.forEach(r => {
    if (historyFilter !== 'all' && r.event_type !== historyFilter) return;
    all.push({ time: r.started_at, html: `
      <div class="record-item">
        <div>
          <div style="font-weight: 600;">${getEmoji(r.event_type)} ${r.event_label} ${r.ended_at ? '(' + formatDuration(r.duration_minutes) + ')' : '<span style="color:#E91E63">è¿›è¡Œä¸­</span>'}</div>
          <div class="record-time">${formatDate(r.started_at)} ${formatTime(r.started_at)}${r.ended_at ? ' â†’ ' + formatTime(r.ended_at) : ''}</div>
          <div class="record-time">${r.started_by}${r.ended_by ? ' â†’ ' + r.ended_by : ''}</div>
        </div>
        <span class="delete-btn" onclick="deleteDuration(${r.id})">Ã—</span>
      </div>
    `});
  });

  all.sort((a, b) => new Date(b.time) - new Date(a.time));
  
  if (all.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">&#x1F4CB;</div><div class="empty-text">æš‚æ— å†å²è®°å½•</div></div>';
    return;
  }

  // æŒ‰æ—¥æœŸåˆ†ç»„
  const groups = {};
  all.forEach(item => {
    const date = formatDate(item.time);
    if (!groups[date]) groups[date] = [];
    groups[date].push(item.html);
  });

  list.innerHTML = Object.entries(groups).map(([date, items]) => `
    <div class="card">
      <div style="font-size: 14px; font-weight: 600; color: #999; margin-bottom: 8px;">${date}</div>
      ${items.join('')}
    </div>
  `).join('');
}

// ===== å¼¹çª— =====
function showInstantModal() { document.getElementById('instantModal').classList.add('show'); }
function showDurationModal() { document.getElementById('durationModal').classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

// ç‚¹å‡»é®ç½©å…³é—­
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('show');
  });
});

// ===== Toast =====
function showToast(msg) {
  const toast = document.createElement('div');
  toast.textContent = msg;
  Object.assign(toast.style, {
    position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
    background: 'rgba(0,0,0,0.75)', color: 'white', padding: '12px 24px',
    borderRadius: '12px', fontSize: '15px', fontWeight: '600', zIndex: '999',
    animation: 'fadeIn 0.2s'
  });
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 1500);
}

// ===== å·¥å…·å‡½æ•° =====
function toLocalISO(date) {
  const offset = date.getTimezoneOffset();
  const local = new Date(date.getTime() - offset * 60000);
  return local.toISOString().slice(0, -1);
}

function formatTime(isoStr) {
  const d = new Date(isoStr);
  return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
}

function formatDate(isoStr) {
  const d = new Date(isoStr);
  return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
}

function timeAgo(isoStr) {
  const now = new Date();
  const then = new Date(isoStr);
  const diffMs = now - then;
  const mins = Math.floor(diffMs / 60000);
  if (mins < 1) return 'åˆšåˆš';
  if (mins < 60) return `${mins}åˆ†é’Ÿ`;
  const hours = Math.floor(mins / 60);
  const remainMins = mins % 60;
  if (hours < 24) return remainMins > 0 ? `${hours}å°æ—¶${remainMins}åˆ†é’Ÿ` : `${hours}å°æ—¶`;
  const days = Math.floor(hours / 24);
  return `${days}å¤©`;
}

function formatDuration(minutes) {
  if (minutes < 1) {
    const secs = Math.round(minutes * 60);
    return `${secs}ç§’`;
  }
  const h = Math.floor(minutes / 60);
  const m = Math.floor(minutes % 60);
  if (h > 0) return `${h}æ—¶${m}åˆ†`;
  return `${m}åˆ†é’Ÿ`;
}

function getElapsedMinutes(startISO) {
  return (new Date() - new Date(startISO)) / 60000;
}

function getEmoji(type) {
  const map = {
    diaper: 'ğŸ§·', feed: 'ğŸ¼', breastfeed: 'ğŸ¼', sunbath: 'â˜€ï¸',
    poop: 'ğŸ’©', bath: 'ğŸ›', sleep: 'ğŸ˜´', wake: 'ğŸŒ',
    medicine: 'ğŸ’Š', tummy: 'ğŸ‘¶', play: 'ğŸ¨', nap: 'ğŸ˜´', walk: 'ğŸš¶'
  };
  return map[type] || 'ğŸ“';
}

// ===== æ³¨å†Œ Service Worker =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}
</script>
</body>
</html>
